---
title: "golang-migrateã§ã®PostgreSQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‚™å¿˜éŒ²"
emoji: "ğŸ¹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go"]
published: true
---

# ã¯ã˜ã‚ã«

æœ€è¿‘ Go ã§ã® WebAPI åˆ¶ä½œã«æŒ‘æˆ¦ã—ã¯ã˜ã‚ã¦ã€DB ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‘¨ã‚Šã‚’ã¯ã˜ã‚ã¦è§¦ã£ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦æ›¸ãã¾ã—ãŸã€‚

# è©³ç´°

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã«ã¯ golang-migrate ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
ç¾åœ¨ ORM ã«ä½¿ã£ã¦ã„ã‚‹ GORM ã«ã‚‚ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ãŒã€æ©Ÿèƒ½ãŒä¹ã—ãã†ã ã£ãŸã®ã§å°‚ç”¨ãƒ„ãƒ¼ãƒ«ã® golang-migrate ã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚
é¸å®šåŸºæº–ã¯æ¤œç´¢ã—ã¦ä¸€ç•ªä¸Šã«å‡ºã¦ããŸã‹ã‚‰ã§ã™ï¼ï¼ï¼ï¼

## DB ç«‹ã¡ä¸Šã’

PostgreSQL ã®å…¬å¼ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§ç«‹ã¡ä¸Šã’ã¾ã—ãŸã€‚
ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€åº¦æ¶ˆã—ãŸã‚ã¨ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¡è¶Šã›ã‚‹ã‚ˆã†ã€åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚(åŒ¿åã§ã‚‚ãƒã‚¤ãƒ³ãƒ‰ã§ã‚‚ã‚ˆã„)
ç’°å¢ƒå¤‰æ•°ã®ã¨ã“ã¯ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§é©å½“ã«...ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒãã®ã¾ã¾ DB åã«ãªã‚Šã¾ã™ã€‚

```yaml:docker-compose.yml
version: "3"
services:
  db:
    image: postgres:14.1-alpine
    ports:
      - 5432:5432
    volumes:
      - sample:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin-password
      LANG: ja_JP.utf8
      TZ: Asia/Tokyo
volumes:
  sample:
    driver: local
```

èµ·å‹•ã—ã¨ãã¾ã—ã‚‡ã†ï¼

```sh
$ docker-compose up -d
```

## CLI ã§è©¦ã™

æœ€çµ‚çš„ã«ã‚³ãƒ¼ãƒ‰å†…ã«è¨˜è¿°ã—ã¾ã™ãŒã€ä¸€æ—¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
$ brew install golang-migrate
```

ã‚ã¨ã¯[å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://github.com/golang-migrate/migrate/blob/master/database/postgres/TUTORIAL.md)ã®æµã‚Œã«å¾“ã£ã¦...

```sh
$ migrate create -ext sql -dir db/migrations -seq create_bookmarks_table
```

ã™ã‚‹ã¨ã€`db/migrations` ä»¥ä¸‹ã« `000001_create_bookmarks_table.up.sql` ã¨ `000001_create_bookmarks_table.down.sql` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ï¼

æ•°å­—ã®éƒ¨åˆ†ãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ãã®å¾Œã«`-seq` ã§æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åãŒå…¥ã‚Šã€`up` ã¨ `down` ç”¨ãŒãã‚Œãã‚Œå­˜åœ¨ã™ã‚‹æ„Ÿã˜ã§ã™ã­ã€‚`up` ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã€`down`ã§è½ã¨ã™ã®ã§ã€`down` ã¯ `up` ã§æ›¸ã„ãŸå†…å®¹ã‚’ãã®ã¾ã¾é€†ã«è¡Œã† SQL ã‚’æ›¸ãã£ã¦ã“ã¨ã§ã™ã­(migration åˆå¿ƒè€…ãªã®ã§ã¯ã˜ã‚ã¦çŸ¥ã‚Šã¾ã—ãŸ)ã€‚

æ—©é€Ÿãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ(up)ã‚’æ›¸ãã¾ã™ã€‚(URL ã®æœ€å¤§æ–‡å­—æ•°ãŒ 50 ãªã®ã¯æ°—ã«ã—ãªã„ã§ãã ã•ã„...)

```sql:000001_create_bookmarks_table.up.sql
CREATE TABLE IF NOT EXISTS bookmarks(
   id serial PRIMARY KEY,
   url VARCHAR (50) UNIQUE
);
```

ç¶šã„ã¦ down ã®æ–¹ã‚‚æ›¸ãã¾ã™ã€up ã®é€†ãªã®ã§ `DROP TABLE` ã§ã™ã­ã€‚

```sql:000001_create_bookmarks_table.down.sql
DROP TABLE IF EXISTS bookmarks;
```

ä¸€æ—¦ç¾æ™‚ç‚¹ã® DB æ§‹æˆã‚’è¦‹ã‚‹ã¨...

```sh
$ export POSTGRESQL_URL=postgres://admin:admin-password@localhost:5432/admin?sslmode=disable
$ psql ${POSTGRESQL_URL}
psql (14.1)
Type "help" for help.

admin=# \d
             List of relations
 Schema |       Name        | Type  | Owner
--------+-------------------+-------+-------
 public | schema_migrations | table | admin
(1 row)

admin=#
```

`schema_migrations` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³(`version`)ã¨ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®å¤‰æ›´ãŒæ­£å¸¸ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã‹(`dirty`)ã‚’ä¿å­˜ã—ã¦ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

ã“ã“ã§å…ˆç¨‹æ›¸ã„ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1 ã‚’é©ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```sh
$ migrate -database ${POSTGRESQL_URL} -path tools/db/migration up 1
1/u create_bookmarks_table (23.938542ms)
```

ã‚‚ã†ä¸€åº¦ DB ã‚’ç¢ºèªã™ã‚‹ã¨...

```sh
$ psql ${POSTGRESQL_URL}
psql (14.1)
Type "help" for help.

admin=# \d
               List of relations
 Schema |       Name        |   Type   | Owner
--------+-------------------+----------+-------
 public | bookmarks         | table    | admin
 public | bookmarks_id_seq  | sequence | admin
 public | schema_migrations | table    | admin
(3 rows)

admin=#
```

ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¦ã¾ã™ï¼

ä»Šåº¦ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è½ã¨ã—ã¦ DB æ§‹æˆã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
$ migrate -database ${POSTGRESQL_URL} -path tools/db/migration down
Are you sure you want to apply all down migrations? [y/N]
y
Applying all down migrations
1/d create_bookmarks_table (35.738583ms)

$ psql $POSTGRESQL_URL
psql (14.1)
Type "help" for help.

admin=# \d
             List of relations
 Schema |       Name        | Type  | Owner
--------+-------------------+-------+-------
 public | schema_migrations | table | admin
(1 row)

admin=#
```

å…ˆã»ã©ä½œæˆã•ã‚ŒãŸã‚‚ã®ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

:::message
SQL ã«èª¤ã‚ŠãŒã‚ã‚‹ãªã©ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ãŸå ´åˆã€å…ˆã»ã©ç´¹ä»‹ã—ãŸ dirty ãƒ•ãƒ©ã‚°ãŒ true ã«ãªã‚Šã€up ã‚„ down ã«ã‚ˆã‚‹å¤‰æ›´ã‚’å—ã‘ä»˜ã‘ãªããªã‚Šã¾ã™ã€‚force ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã€1 ã¤å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¼·åˆ¶çš„ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚
:::

## Go ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è©¦ã™

å®Ÿéš›ã®ã¨ã“ã‚ã¯ã€`go run`ã—ãŸã¨ãã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚å®Ÿè¡Œã—ãŸã„ã“ã¨ãŒå¤šã„ã¨æ€ã†ã®ã§ã€ã‚³ãƒ¼ãƒ‰å†…ã¸ã®è¨˜è¿°ã‚’ã—ã¾ã™ã€‚
`migrate.New()`ã®å¼•æ•°ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰è¦‹ãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã® path ã¨ã€CLI ã§ã‚‚ä½¿ç”¨ã—ãŸ URL ã‚’æ¸¡ã—ã¾ã™ã€‚

```go
package config

import (
	"github.com/golang-migrate/migrate/v4"
	_ "github.com/golang-migrate/migrate/v4/database/postgres"
	_ "github.com/golang-migrate/migrate/v4/source/file"
	"github.com/jinzhu/gorm"
	_ "github.com/jinzhu/gorm/dialects/postgres"
)

--ä¸­ç•¥--

m, err := migrate.New(
	"file://tools/db/migration",
	"postgres://admin:admin-password@localhost:5432?sslmode=disable",
)
if err != nil {
	panic(err)
}
if err := m.Up(); err != nil {
	if err != migrate.ErrNoChange {
		panic(err)
	}
}
```

ç‰¹ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãŒãªã‹ã£ãŸå ´åˆã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã£ãŸã®ã§ã€è‡ªåˆ†ã¯ ErrNoChange ã ã‘è¨±å®¹ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¾ã™ã€‚
ã“ã‚Œã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã™ï¼

## ã¾ã¨ã‚

ä»•äº‹ã§ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã‚¤ãƒ³ãƒ•ãƒ©å‘¨ã‚Šã—ã‹è§¦ã£ãŸã“ã¨ãŒãªã„ã®ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è‡ªä½“ã¯ã˜ã‚ã¦ã§ã—ãŸãŒã€ã‚³ãƒãƒ³ãƒ‰ãŒç›´æ„Ÿçš„ã§ã‚ã‹ã‚Šã‚„ã™ãã€åˆå¿ƒè€…ã«å„ªã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã—ãŸ ğŸ˜„
ä»–ã®æœ‰åãªãƒ„ãƒ¼ãƒ«ã‚‚è§¦ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
