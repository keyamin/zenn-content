---
title: "Terraformã¨AWS CDKã®plan(diff)ã®æŒ™å‹•ãŒé•ã£ã¦æˆ¸æƒ‘ã£ãŸè©±"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Terraform", "CDK"]
published: true
---

## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã® keyamin ã§ã™ã€‚

è‡ªåˆ†ã¯ IaC ãŒã‘ã£ã“ã†å¥½ãã§ä»•äº‹ã§ã‚‚æ›¸ãã“ã¨ãŒå¤šãã€å‰è·ã§ 1 å¹´å¼± Terraform ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸãŒæ˜¨å¹´ 11 æœˆã«è»¢è·ã—ã¦ã‹ã‚‰ã¯ AWS CDK ã‚’å‹‰å¼·ã—ã¦ã„ã¾ã™ã€‚

ãã®éš›ã« Terraform ã® plan ã‚³ãƒãƒ³ãƒ‰ã¨ CDK ã® diff ã‚³ãƒãƒ³ãƒ‰ã®æŒ™å‹•ã®é•ã„ã€ã¾ãŸãƒ‰ãƒªãƒ•ãƒˆã®æ‰±ã„ã®é•ã„ã§æˆ¸æƒ‘ã£ãŸéƒ¨åˆ†ãŒã‚ã£ãŸã®ã§ã€æ¤œè¨¼ãƒ»è€ƒå¯Ÿã—ã¦ã¿ã¾ã—ãŸã€‚

## TL;DR

:::message alert
æ¤œè¨¼çµæœã‹ã‚‰ã®æ¨æ¸¬ã§ã™ã®ã§ã€èª¤ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æŒ‡æ‘˜ãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã€Twitter ãªã©ã‹ã‚‰ã”é€£çµ¡ãŠé¡˜ã„ã—ã¾ã™ ğŸ™‡
:::

1. Terraform ã® plan ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€å®Ÿè¡Œæ™‚ã« state ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã®å®Ÿéš›ã®è¨­å®šã‚’ç¢ºèªã—ã«è¡Œãã€ãƒ‰ãƒªãƒ•ãƒˆãŒç™ºç”Ÿã—ã¦ãŸã‚‰ãã‚Œã‚‚å«ã‚ã¦ã‚³ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã«ä¸Šæ›¸ãã™ã‚‹ã‚ˆã†ãªè¨ˆç”»ã‚’å‡ºåŠ›ã™ã‚‹ã€‚apply ã‚³ãƒãƒ³ãƒ‰ã§ã¯ãã‚Œã‚’ãã®ã¾ã¾å®Ÿè¡Œã™ã‚‹ã€‚

2. CDK ã® diff ã‚³ãƒãƒ³ãƒ‰ã‚„ CloudFormation ã®å¤‰æ›´ã‚»ãƒƒãƒˆã§ã¯ã€ç¾åœ¨ã® CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨æ‰‹å…ƒã§ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¯”è¼ƒã—ã€ãã®å·®åˆ†ã‚’è¨ˆç”»ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã€‚ã“ã®éš›ãƒ‰ãƒªãƒ•ãƒˆã¯è€ƒæ…®ã•ã‚Œãªã„ã€‚

3. CDK ã® deploy ã‚³ãƒãƒ³ãƒ‰ã‚„ CloudFormation ã®å¤‰æ›´ã‚»ãƒƒãƒˆã®å®Ÿè¡Œã§ã¯ã€åŸºæœ¬çš„ã«ã¯å¤‰æ›´ã‚»ãƒƒãƒˆã®å†…å®¹ã‚’ãã®ã¾ã¾å®Ÿè¡Œã™ã‚‹ã€‚ãŸã ã—ã€å¤‰æ›´å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã«ãƒ‰ãƒªãƒ•ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã€**å ´åˆã«ã‚ˆã£ã¦ã¯**ãƒ‰ãƒªãƒ•ãƒˆã—ã¦ã„ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚³ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

https://github.com/keyamin/cdk-tf-diff

## CDK ã«ã¯ã˜ã‚ã¦è§¦ã£ãŸã¨ãã«ä½“é¨“ã—ãŸä¸æ€è­°ãªå‡ºæ¥äº‹

ã¾ãšã¯ã€Terraform ã§ SQS ã‚­ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
ã‚­ãƒ¥ãƒ¼åã¨å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```hcl
resource "aws_sqs_queue" "sample_queue" {
  name                       = "sample-tf-queue"
  visibility_timeout_seconds = 10
}
```

ã“ã‚Œã‚’`terraform apply`ã™ã‚‹ã¨ã€å½“ç„¶ãªãŒã‚‰ã‚­ãƒ¥ãƒ¼ãŒã§ãã¾ã™ã€‚

:::details apply çµæœ

```hcl
$ terraform apply

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_sqs_queue.sample_queue_ will be created
  + resource "aws_sqs_queue" "sample_queue" {
      + arn                               = (known after apply)
      + content_based_deduplication       = false
      + deduplication_scope               = (known after apply)
      + delay_seconds                     = 0
      + fifo_queue                        = false
      + fifo_throughput_limit             = (known after apply)
      + id                                = (known after apply)
      + kms_data_key_reuse_period_seconds = (known after apply)
      + max_message_size                  = 262144
      + message_retention_seconds         = 345600
      + name                              = "sample-tf-queue"
      + name_prefix                       = (known after apply)
      + policy                            = (known after apply)
      + receive_wait_time_seconds         = 0
      + redrive_allow_policy              = (known after apply)
      + redrive_policy                    = (known after apply)
      + sqs_managed_sse_enabled           = (known after apply)
      + tags_all                          = (known after apply)
      + url                               = (known after apply)
      + visibility_timeout_seconds        = 10
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

aws_sqs_queue.sample_queue: Creating...
aws_sqs_queue.sample_queue: Still creating... [10s elapsed]
aws_sqs_queue.sample_queue: Still creating... [20s elapsed]
aws_sqs_queue.sample_queue: Creation complete after 25s [id=https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxx/sample-tf-queue]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

:::

ã“ã“ã§ sample-tf-queue ã®å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ 20 ç§’ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãã®å¾Œã‚³ãƒ¼ãƒ‰ã¯å¤‰ãˆãªã„ã¾ã¾å†åº¦`terraform plan`ã™ã‚‹ã¨ã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã€å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚³ãƒ¼ãƒ‰å´ã® 10 ç§’ã«æˆ»ã™ã‚ˆã†ãªçµæœãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

:::details plan çµæœ

```hcl
$ terraform plan

aws_sqs_queue.sample_queue: Refreshing state... [id=https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxx/sample-tf-queue]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  ~ update in-place

Terraform will perform the following actions:

  # aws_sqs_queue.sample_queue will be updated in-place
  ~ resource "aws_sqs_queue" "sample_queue" {
        id                                = "https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxx/sample-tf-queue"
        name                              = "sample-tf-queue"
        tags                              = {}
      ~ visibility_timeout_seconds        = 20 -> 10
        # (11 unchanged attributes hidden)
    }

Plan: 0 to add, 1 to change, 0 to destroy.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now.
```

:::

Terraform ã«æ…£ã‚Œã¦ã„ãŸè‡ªåˆ†ã«ã¨ã£ã¦ã¯ã€ã“ã‚ŒãŒå½“ãŸã‚Šå‰ã®æŒ™å‹•ã§ã—ãŸã€‚

CDK ã§ã‚‚åŒã˜ã“ã¨ã‚’ã‚„ã£ã¦ã¿ã¾ã™ã€‚(æ¤œè¨¼ã®éƒ½åˆä¸Š L1 Construct ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™)

```ts
export class CdkStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new sqs.CfnQueue(this, "SampleQueue", {
      queueName: "sample-cdk-queue",
      visibilityTimeout: 10,
    });
  }
}
```

`cdk deploy`ã§ã‚­ãƒ¥ãƒ¼ä½œæˆå¾Œã€Terraform ã¨åŒã˜ã sample-cdk-queue ã®å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ 20 ç§’ã«å¤‰æ›´ã—ã€`cdk plan`ã‚’ã—ã¦ã¿ã¾ã™ã€‚ã™ã‚‹ã¨...

```bash
$ cdk diff

Stack CdkStack
There were no differences
```

ãŠã‚„ï¼Ÿ

ä¸å®‰ã«ãªã‚Šã¤ã¤ä¸€å¿œ deploy ã‚‚ã—ã¦ã¿ã¾ã—ãŸãŒã€diff ã®çµæœé€šã‚Šã€å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ 20 ç§’ã®ã¾ã¾ã§ã—ãŸã€‚

:::details deploy çµæœ

```bash
$ cdk deploy

âœ¨  Synthesis time: 1.97s

CdkStack: building assets...

[0%] start: Building 5b7ea873c4531c4e9be5ad0dbf9e6992b9068ec132dc7053c88088fb9adc6385:current_account-current_region
[100%] success: Built 5b7ea873c4531c4e9be5ad0dbf9e6992b9068ec132dc7053c88088fb9adc6385:current_account-current_region

CdkStack: assets built

CdkStack: deploying... [1/1]
[0%] start: Publishing 5b7ea873c4531c4e9be5ad0dbf9e6992b9068ec132dc7053c88088fb9adc6385:current_account-current_region
[100%] success: Published 5b7ea873c4531c4e9be5ad0dbf9e6992b9068ec132dc7053c88088fb9adc6385:current_account-current_region

 âœ¨ hotswap deployment skipped - no changes were detected (use --force to override)


 âœ…  CdkStack (no changes)

âœ¨  Deployment time: 1.15s

Stack ARN:
arn:aws:cloudformation:ap-northeast-1:xxxxxxxxxxxx:stack/CdkStack/7a894e10-ba67-11ed-96c1-0a72591af2a9

âœ¨  Total time: 3.12s
```

:::

å¿µã®ç‚ºã€`cdk synth`ã§å‡ºåŠ›ã•ã‚ŒãŸ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å¤‰æ›´ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã€ãã‚Œã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸãŒçµæœã¯åŒã˜ã§ã—ãŸã€‚

:::message
ã¡ãªã¿ã«`cdk deploy`ã‚³ãƒãƒ³ãƒ‰ã§ã¯å†…éƒ¨ã§ CloudFormation ã®å¤‰æ›´ã‚»ãƒƒãƒˆãŒä½œæˆã•ã‚Œã€å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚`--no-execute`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã¨å¤‰æ›´ã‚»ãƒƒãƒˆã®ä½œæˆã®ã¿ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

diff ã‚³ãƒãƒ³ãƒ‰ãŒå¤‰æ›´ã‚»ãƒƒãƒˆã¨åŒã˜çµæœã«ãªã‚‹ã€ã¨ã„ã†è¨˜è¿°ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã™ãŒã€ã“ã®ã“ã¨ã‹ã‚‰ã—ã¦ã‚‚ diff ã‚³ãƒãƒ³ãƒ‰ã®çµæœ = å¤‰æ›´ã‚»ãƒƒãƒˆã®å†…å®¹ã¨ã„ã†èªè­˜ã§é€²ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚
:::

ã“ã®æ™‚ç‚¹ã§ã€ Terraform ã¨ CDK ã®æŒ™å‹•ãŒé•ã†ã“ã¨ã«æˆ¸æƒ‘ã„ã¾ã—ãŸ...

## æ¤œè¨¼ â‘ 

ã¾ãšã€æ¬¡ã®ã‚ˆã†ãªæ‰‹é †ã§æ¤œè¨¼ã‚’è¡Œã„ã¾ã—ãŸã€‚

1. å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ 10 ç§’ã«è¨­å®šã—ãŸ SQS ã‚­ãƒ¥ãƒ¼ã‚’ CDK ã‹ã‚‰ä½œæˆã™ã‚‹
2. ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ 20 ç§’ã«å¤‰æ›´ã™ã‚‹
3. CDK ã‹ã‚‰å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ 30 ç§’ã«å¤‰æ›´ã™ã‚‹

ä»¥ä¸Šã‚’è¡Œã£ã¦ diff ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ä»Šåº¦ã¯ diff ã‚ã‚Šã¨ã„ã†çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸãŒã€å¤‰æ›´å‰ã®å€¤ã¯ã‚„ã¯ã‚Šãƒ‰ãƒªãƒ•ãƒˆãŒè€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

```diff ts
export class CdkStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new sqs.CfnQueue(this, "SampleQueue", {
      queueName: "sample-cdk-queue",
-     visibilityTimeout: 10,
+     visibilityTimeout: 30,
    });
  }
}
```

```bash
$ cdk diff

Stack CdkStack
Resources
[~] AWS::SQS::Queue SampleQueue SampleQueue
 â””â”€ [~] VisibilityTimeout
     â”œâ”€ [-] 10
     â””â”€ [+] 30
```

ã“ã¡ã‚‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã‚­ãƒ¥ãƒ¼ã®å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã‚³ãƒ¼ãƒ‰ã®é€šã‚Š 30 ç§’ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

![ã‚­ãƒ¥ãƒ¼ç”»åƒ1](/images/d1f33fa68cdb92/sqs-queue-1.png)

ã“ã“ã§ã€ã“ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ç”¨ã•ã‚ŒãŸå¤‰æ›´ã‚»ãƒƒãƒˆã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

ã€ŒJSON ã®å¤‰æ›´ã€ã‚¿ãƒ–ã‹ã‚‰ã€å¤‰æ›´ã‚»ãƒƒãƒˆã®å†…å®¹ã‚’ JSON å½¢å¼ã§ç¢ºèªã§ãã¾ã™ã€‚

![ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã®å¤‰æ›´ã‚»ãƒƒãƒˆç”»åƒ](/images/d1f33fa68cdb92/cfn-changeset.png)

:::details JSON ã®ä¸­èº«

```json
[
  {
    "resourceChange": {
      "logicalResourceId": "SampleQueue",
      "action": "Modify",
      "physicalResourceId": "https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxx/sample-cdk-queue",
      "resourceType": "AWS::SQS::Queue",
      "replacement": "False",
      "moduleInfo": null,
      "details": [
        {
          "target": {
            "name": "VisibilityTimeout",
            "requiresRecreation": "Never",
            "attribute": "Properties"
          },
          "causingEntity": null,
          "evaluation": "Static",
          "changeSource": "DirectModification"
        }
      ],
      "changeSetId": null,
      "scope": ["Properties"]
    },
    "hookInvocationCount": null,
    "type": "Resource"
  }
]
```

:::

JSON ã®å†…å®¹ã«ã¤ã„ã¦ã®è©³ç´°ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets-view.html)ã‚’å‚ç…§ã—ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ãƒ‘ãƒƒã¨è¦‹ã©ã†ã‚„ã‚‰ sample-cdk-queue ã® VisibilityTimeout ã‚’å¤‰æ›´ã—ã¾ã™ã‚ˆçš„ãªå†…å®¹ã«ãªã£ã¦ã„ãã†ã§ã™ã€‚

ã“ã“ã§ã€å†’é ­ã® 1,2 ç•ªã®ä»®è¨­ã‚’ç«‹ã¦ã¾ã—ãŸã€‚

CDK(CloudFormation)ã§ã¯ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨æ–°è¦ç”Ÿæˆã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¯”è¼ƒã—ã€ãã®å·®åˆ†ã‚’ã€Œã©ã®ãƒªã‚½ãƒ¼ã‚¹ã®ã©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã¾ã™ã€ã¨ã„ã£ãŸå¤‰æ›´ã‚»ãƒƒãƒˆã¨ã—ã¦ç”Ÿæˆã€ãã—ã¦ãã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã®ã§ã¯ãªã„ã‹...

Terraform ã§ã¯ apply ã‚³ãƒãƒ³ãƒ‰ã«ã¯[--refresh-only](https://developer.hashicorp.com/terraform/tutorials/state/refresh)ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã€ç¾åœ¨ã®ã‚¤ãƒ³ãƒ•ãƒ©ã®è¨­å®šã‚’ state ãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ ã•ã›ã‚‹(ãƒ‰ãƒªãƒ•ãƒˆã‚’ç¾åœ¨ã®è¨­å®šã‚’æ­£ã¨ã—ã¦è§£æ¶ˆã™ã‚‹)ã“ã¨ãŒã§ãã¾ã™ã€‚only ã¨æ›¸ã„ã¦ã‚ã‚‹ã‹ã‚‰ã«ã¯å®Ÿéš›ã® plan,apply æ™‚ã«ã‚‚ã“ã®ã‚ˆã†ãªã“ã¨ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã€‚(ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¾ã§ã¯è¿½ãˆã¦ãªã„ã§ã™...ğŸ™‡)

## æ¤œè¨¼ â‘¡

æ¬¡ã¯ã€

1. å…ˆç¨‹ã¨åŒã˜ãå¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ 10 ç§’ã® SQS ã‚­ãƒ¥ãƒ¼ã‚’ä½œæˆ
2. ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ 20 ç§’ã«å¤‰æ›´
3. CDK ã‹ã‚‰ã‚­ãƒ¥ãƒ¼ã®é…ä¿¡é…å»¶ã‚’ 10 ç§’ã«å¤‰æ›´

ã¨ã„ã†æ‰‹é †ã‚’è¸ã‚“ã§ã¿ã¾ã™ã€‚

å…ˆç¨‹ã®å¤‰æ›´ã‚»ãƒƒãƒˆã® JSON ã‚’è¦‹ã‚‹é™ã‚Šã ã¨å¤‰æ›´å¯¾è±¡ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åãŒè¨˜è¼‰ã•ã‚Œã¦ã„ãŸã“ã¨ã‹ã‚‰ã€é…ä¿¡é…å»¶ã‚’ CDK ã‹ã‚‰å¤‰æ›´ã—ãŸã¨ã“ã‚ã§ã€å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ãƒ‰ãƒªãƒ•ãƒˆã—ãŸå€¤ã®ã¾ã¾å¤‰ã‚ã‚‰ãªã„ã®ã§ã¯ã¨äºˆæƒ³ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã—ã¦ diff,deploy ã—ã¦ã¿ã¾ã™ã€‚

```diff ts
export class CdkStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new sqs.CfnQueue(this, "SampleQueue", {
      queueName: "sample-cdk-queue",
      visibilityTimeout: 10,
+     delaySeconds: 10,
    });
  }
}
```

çµæœã¯...ãªã‚“ã¨å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚‚ CDK ã‚³ãƒ¼ãƒ‰å´ã®å€¤ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã‚‚å¤‰æ›´ã‚»ãƒƒãƒˆã® JSON ã‚’è¦‹ã¦ã‚‚å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´ã™ã‚‹æ—¨ã¯æ›¸ã„ã¦ã„ã¾ã›ã‚“ã€‚ãªãœ...

![ã‚­ãƒ¥ãƒ¼ç”»åƒ2](/images/d1f33fa68cdb92/sqs-queue-2.png)

:::details å¤‰æ›´ã‚»ãƒƒãƒˆã® JSON

```json
[
  {
    "resourceChange": {
      "logicalResourceId": "SampleQueue",
      "action": "Modify",
      "physicalResourceId": "https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxx/sample-cdk-queue",
      "resourceType": "AWS::SQS::Queue",
      "replacement": "False",
      "moduleInfo": null,
      "details": [
        {
          "target": {
            "name": "DelaySeconds",
            "requiresRecreation": "Never",
            "attribute": "Properties"
          },
          "causingEntity": null,
          "evaluation": "Static",
          "changeSource": "DirectModification"
        }
      ],
      "changeSetId": null,
      "scope": ["Properties"]
    },
    "hookInvocationCount": null,
    "type": "Resource"
  }
]
```

:::

## æ¤œè¨¼ â‘¢

ãªãœã“ã‚“ãªçµæœã«ãªã£ãŸã‹è€ƒãˆã¾ã—ãŸãŒã€AWS CLI ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ãŸã¨ã“ã‚ã€ã©ã†ã‚„ã‚‰ SQS ã«ã¯ã‚­ãƒ¥ãƒ¼ã®å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå˜ä½“ã‚’ç·¨é›†ã™ã‚‹ API ãŒãªã•ãã†ã§ã—ãŸã€‚([set-queue-attributes](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sqs/set-queue-attributes.html))

set-queue-attributes ã§ã‚‚æŒ‡å®šã—ãªã‹ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯å¤‰æ›´ãŒåŠ ãˆã‚‰ã‚Œãªã„ãŸã‚å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã ã‘ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã®ã§ã™ãŒã€CloudFormation ãŒå†…éƒ¨ã§ PATCH ã§ã¯ãªã PUT çš„ãªæŒ™å‹•ã‚’ã—ã¦ã„ãŸå ´åˆã€é…ä¿¡é…å»¶ã®å¤‰æ›´ã«å·»ãè¾¼ã¾ã‚Œã¦å¯è¦–æ€§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒå¤‰ã‚ã£ã¦ã—ã¾ã£ãŸã“ã¨ã‚‚ç´å¾—ã§ãã¾ã™ã€‚

ã“ã‚Œã‚’ç¢ºã‹ã‚ã‚‹ãŸã‚ã€æ¬¡ã®æ¤œè¨¼ã‚’è¡Œã„ã¾ã—ãŸã€‚

1. CDK ã‹ã‚‰ KMS ã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹
2. CDK ã‹ã‚‰ CloudWatch ã®ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã€ä¿æŒæœŸé–“ã‚’ 30 æ—¥ã€ä½¿ç”¨ã™ã‚‹ KMS ã‚­ãƒ¼ã« 1 ã§ä½œæˆã—ãŸã‚­ãƒ¼ã‚’æŒ‡å®šã™ã‚‹
3. ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ­ã‚°ã®ä¿æŒæœŸé–“ã‚’ 7 æ—¥ã«å¤‰æ›´ã™ã‚‹
4. CDK ã‹ã‚‰ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã¨ KMS ã‚­ãƒ¼ã®é–¢é€£ä»˜ã‘ã‚’å‰Šé™¤ã™ã‚‹

CloudWatch ã®ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã§ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é–¢é€£ä»˜ã‘ã‚‹ KMS ã‚­ãƒ¼ã¨ãƒ­ã‚°ã®ä¿æŒæœŸé–“ã‚’è¨­å®šã§ãã¾ã™ã€‚ãã—ã¦ã€ãã‚Œã‚‰ã«ã¯ãã‚Œãã‚Œå€‹åˆ¥ã«å¤‰æ›´ã™ã‚‹ API ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚([disassociate-kms-key](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/logs/disassociate-kms-key.html)ã¨[put-retention-policy](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/logs/put-retention-policy.html))

ãªã®ã§ã€ã“ã‚Œãªã‚‰ç‰‡æ–¹ã®å¤‰æ›´ã«ã‚‚ã†ç‰‡æ–¹ãŒå·»ãè¾¼ã¾ã‚Œãªã„ã®ã§ã¯ãªã„ã‹ã€ã¨ã„ã†æ¤œè¨¼ã§ã™ã€‚

ä»¥ä¸‹ãŒ CDK ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```ts
export class CdkStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const key = new kms.Key(this, "SampleKey", {
      policy: new iam.PolicyDocument({
        statements: [
          new iam.PolicyStatement({
            actions: ["kms:*"],
            resources: ["*"],
            principals: [new iam.AccountRootPrincipal()],
          }),
          new iam.PolicyStatement({
            actions: [
              "kms:Decrypt*",
              "kms:Encrypt*",
              "kms:ReEncrypt*",
              "kms:GenerateDataKey*",
              "kms:Describe*",
            ],
            resources: ["*"],
            principals: [
              new iam.ServicePrincipal(`logs.${this.region}.amazonaws.com`),
            ],
            conditions: {
              ArnEquals: {
                "kms:EncryptionContext:aws:logs:arn": `arn:aws:logs:${this.region}:${this.account}:log-group:*`,
              },
            },
          }),
        ],
      }),
      removalPolicy: cdk.RemovalPolicy.DESTROY,
    });

    new logs.CfnLogGroup(this, "SampleLogGroup", {
      logGroupName: "sample-cdk-log-group",
      retentionInDays: 30,
      kmsKeyId: key.keyArn, // ãªã‚“ã§key.keyIdã˜ã‚ƒãªã„ã®ï¼ï¼
    });
  }
}
```

æ‰‹é †é€šã‚Šå®Ÿè¡Œã—ãŸã¨ã“ã‚ã€äºˆæƒ³é€šã‚Šã€KMS ã‚­ãƒ¼ã®é–¢é€£ä»˜ã‘ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸãŒã€ä¿æŒæœŸé–“ã¯ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å¤‰æ›´ã—ãŸ 7 æ—¥ã®ã¾ã¾ã§ã—ãŸã€‚

![ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ç”»åƒ](/images/d1f33fa68cdb92/log-group.png)

:::details å¤‰æ›´ã‚»ãƒƒãƒˆã® JSON

```json
[
  {
    "resourceChange": {
      "logicalResourceId": "SampleLogGroup",
      "action": "Modify",
      "physicalResourceId": "sample-cdk-log-group",
      "resourceType": "AWS::Logs::LogGroup",
      "replacement": "False",
      "moduleInfo": null,
      "details": [
        {
          "target": {
            "name": "KmsKeyId",
            "requiresRecreation": "Never",
            "attribute": "Properties"
          },
          "causingEntity": null,
          "evaluation": "Static",
          "changeSource": "DirectModification"
        }
      ],
      "changeSetId": null,
      "scope": ["Properties"]
    },
    "hookInvocationCount": null,
    "type": "Resource"
  }
]
```

:::

# ã¾ã¨ã‚

æ¤œè¨¼çµæœã‹ã‚‰è‡ªåˆ†ãŒæ¨æ¸¬ã—ãŸã®ã¯å†’é ­ã§æ›¸ã„ãŸã¨ãŠã‚Šã§ã™ã€‚

Terraform ã«ã¯æŒ‡å®šã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®å·®åˆ†ã‚’ç„¡è¦–ã§ãã‚‹ ignore_changes ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ãŒã€CDK ã§ã¯ã“ã®æŒ™å‹•ãªã‚‰ãã‚‚ãã‚‚å¿…è¦ãªã„ã§ã™ã­ã€‚ãƒ‰ãƒªãƒ•ãƒˆã‚’ç„¡è¦–ã—ç¶šã‘ã¦ã‚‚ã€ãã®ãƒªã‚½ãƒ¼ã‚¹ã«è§¦ã‚‰ãªã‘ã‚Œã°ä½•ã‚‚èµ·ãã¾ã›ã‚“ã€‚

ãŸã ã—ã€ãƒ‰ãƒªãƒ•ãƒˆãŒã‚ã‚‹ã¨ diff çµæœã¨ç•°ãªã‚‹æŒ™å‹•ã‚’ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã¯å°‘ã—å«Œã ãªãƒ¼ã¨æ€ã„ã¾ã—ãŸã€‚ECS Ã— CodeDeploy ã§ Blue/Green ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ããªã©ã€ãƒ‰ãƒªãƒ•ãƒˆãŒã©ã†ã—ã¦ã‚‚ç™ºç”Ÿã—ã¦ã—ã¾ã†å ´é¢ã¯ã‚ã‚Šã€ä¾‹ãˆã°ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’ã¡ã‚‡ã£ã¨ã„ã˜ã£ãŸéš›ã«ãƒªã‚¹ãƒŠãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæ„å›³ã›ãšå¤‰ã‚ã£ã¦ã—ã¾ã†ã®ã¯æ€–ã„ã§ã™ã€‚ãªã®ã§ Terraform ã®æŒ™å‹•ã®æ–¹ãŒç›´æ„Ÿçš„ã§è‡ªåˆ†ã¯å¥½ãã§ã—ãŸã€‚

ã‚ã¨ã€ãƒ‰ãƒªãƒ•ãƒˆæ¤œå‡ºãŒç¾æ™‚ç‚¹ã§ã¯ CloudFormation ã‹ã‚‰ã—ã‹è¡Œãˆãšã€ CDK ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ç›´æ¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚Œã°ã‚ã¡ã‚ƒãã¡ã‚ƒä¾¿åˆ©ã ã¨æ€ã†ã®ã§ã€ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ ğŸ™
